<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå§Ô∏è Toulouse Weather Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto auto;
            gap: 15px;
            align-items: end;
        }

        @media (max-width: 1200px) {
            .controls {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        select, input[type="number"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        select:focus, input[type="number"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="date"].active {
            border-color: #667eea;
            background-color: #f0f4ff;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: 100%;
            margin-top: 0;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* ‚úÖ NEW: Export button style */
        .btn-export {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .btn-export:hover {
            background: linear-gradient(135deg, #38d66d 0%, #2de0c9 100%);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .station-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .station-info p {
            margin: 8px 0;
            color: #555;
        }

        .station-info strong {
            color: #333;
        }

        /* ‚úÖ NEW: Loading spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ‚úÖ NEW: Better error styling */
        .error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .error::before {
            content: "‚ö†Ô∏è";
            font-size: 2em;
        }

        .info-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå§Ô∏è Toulouse Weather Dashboard</h1>
            <p class="subtitle">Visualisation interactive des donn√©es m√©t√©orologiques de 44 stations</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="stationSelect">üìç S√©lectionner une station</label>
                <select id="stationSelect" onchange="loadWeatherData()">
                    <option value="">Chargement des stations...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="startDate">üìÖ Date de d√©but</label>
                <input type="date" id="startDate" onchange="updateDateInputStyles(); loadWeatherData();">
            </div>
            <div class="control-group">
                <label for="endDate">üìÖ Date de fin</label>
                <input type="date" id="endDate" onchange="updateDateInputStyles(); loadWeatherData();">
            </div>
            <div class="control-group">
                <button onclick="clearFilters()">üîÑ R√©initialiser</button>
            </div>
            <!-- ‚úÖ NEW: Export CSV button -->
            <div class="control-group">
                <button class="btn-export" onclick="exportToCSV()" id="exportBtn" disabled>üì• Exporter CSV</button>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="infoContainer"></div>
        
        <!-- ‚úÖ NEW: Better loading indicator -->
        <div id="loadingContainer" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Chargement des donn√©es...</p>
        </div>

        <!-- Station Info Row -->
        <div class="info-row">
            <!-- Station Info Card -->
            <div class="card">
                <h2>‚ÑπÔ∏è Informations de la station</h2>
                <div id="stationInfo" class="station-info">
                    <p>S√©lectionnez une station pour voir les d√©tails</p>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <h2>üìà Statistiques</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-box">
                        <div class="stat-label">Temp√©rature moy.</div>
                        <div class="stat-value" id="avgTemp">--¬∞C</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-label">Temp√©rature min/max</div>
                        <div class="stat-value" id="minMaxTemp" style="font-size: 1.5em;">--¬∞C</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-label">Humidit√© moyenne</div>
                        <div class="stat-value" id="avgHumidity">--%</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-label">Pr√©cipitations totales</div>
                        <div class="stat-value" id="totalRain">-- mm</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="stat-label">Vent moyen</div>
                        <div class="stat-value" id="avgWind">-- m/s</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <div class="stat-label">Pression moyenne</div>
                        <div class="stat-value" id="avgPressure" style="font-size: 1.5em;">-- hPa</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                        <div class="stat-label">Nombre de relev√©s</div>
                        <div class="stat-value" id="recordCount">--</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <div class="stat-label">P√©riode</div>
                        <div class="stat-value" id="datePeriod" style="font-size: 1.2em;">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="dashboard">
            <!-- Temperature Chart -->
            <div class="card">
                <h2>üå°Ô∏è √âvolution de la temp√©rature</h2>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Humidity Chart -->
            <div class="card">
                <h2>üíß Humidit√©</h2>
                <div class="chart-container">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üåßÔ∏è Pr√©cipitations</h2>
                <div class="chart-container">
                    <canvas id="rainChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üí® Vent</h2>
                <div class="chart-container">
                    <canvas id="windChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>üå°Ô∏è Pression atmosph√©rique</h2>
                <div class="chart-container">
                    <canvas id="pressureChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let tempChart, humidityChart, rainChart, windChart, pressureChart;
        let isInitialLoad = true;
        let currentWeatherData = []; // ‚úÖ NEW: Store current data for export

        // ‚úÖ NEW: Export to CSV function
        function exportToCSV() {
            if (!currentWeatherData || currentWeatherData.length === 0) {
                showError('Aucune donn√©e √† exporter. Veuillez d\'abord charger des donn√©es.');
                return;
            }

            // Create CSV content
            const headers = ['Date', 'Heure', 'Station', 'Temp√©rature (¬∞C)', 'Humidit√© (%)', 'Pr√©cipitations (mm)', 'Vent (m/s)', 'Pression (hPa)'];
            const rows = currentWeatherData.map(d => {
                const date = new Date(d.timestamp);
                return [
                    date.toLocaleDateString('fr-FR'),
                    date.toLocaleTimeString('fr-FR'),
                    d.station_name.replace(/^\d+-station-meteo-/i, ''),
                    d.temperature != null ? d.temperature.toFixed(1) : '',
                    d.humidity != null ? d.humidity.toFixed(0) : '',
                    d.rainfall != null ? d.rainfall.toFixed(2) : '0.00',
                    d.wind_speed != null ? d.wind_speed.toFixed(1) : '',
                    d.pressure != null ? (d.pressure / 100).toFixed(0) : ''
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            // Create download link
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            // Generate filename with date
            const stationId = document.getElementById('stationSelect').value;
            const today = new Date().toISOString().split('T')[0];
            link.download = `meteo_toulouse_station${stationId}_${today}.csv`;
            
            link.click();
            
            showInfo(`‚úÖ Export r√©ussi ! ${currentWeatherData.length} relev√©s export√©s.`);
        }

        // Load stations on page load
        async function loadStations() {
            try {
                const response = await fetch(`${API_BASE}/stations?limit=100`);
                const stations = await response.json();
                
                const select = document.getElementById('stationSelect');
                select.innerHTML = '<option value="">-- S√©lectionner une station --</option>';
                
                // Find Compans Caffarelli and set it as default
                let defaultStationId = null;
                
                stations.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.station_id;
                    // Clean station name: remove "XX-station-meteo-" prefix
                    const cleanName = station.station_name.replace(/^\d+-station-meteo-/i, '');
                    option.textContent = cleanName;
                    select.appendChild(option);
                    
                    // Check for Compans Caffarelli (case insensitive)
                    if (cleanName.toLowerCase().includes('compans') || 
                        cleanName.toLowerCase().includes('caffarelli')) {
                        defaultStationId = station.station_id;
                    }
                });

                // Set default station
                if (defaultStationId) {
                    select.value = defaultStationId;
                } else if (stations.length > 0) {
                    select.value = stations[0].station_id;
                }
                
                // Load data on initial load
                if (isInitialLoad && select.value) {
                    isInitialLoad = false;
                    loadWeatherData();
                }
            } catch (error) {
                showError('Erreur lors du chargement des stations. V√©rifiez que l\'API est d√©marr√©e (uvicorn src.api.main:app)');
            }
        }

        async function loadWeatherData() {
            const stationId = document.getElementById('stationSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!stationId) {
                showError('Veuillez s√©lectionner une station');
                // ‚úÖ Disable export button
                document.getElementById('exportBtn').disabled = true;
                return;
            }

            showLoading(true);
            clearError();
            clearInfo();

            try {
                // Load station details
                const stationResponse = await fetch(`${API_BASE}/stations/${stationId}`);
                if (!stationResponse.ok) {
                    throw new Error(`Station introuvable (Erreur ${stationResponse.status})`);
                }
                const stationData = await stationResponse.json();

                // Build weather API URL with filters (limit=1000 to get all data)
                let weatherUrl = `${API_BASE}/weather/?station_id=${stationId}&limit=1000`;
                if (startDate) weatherUrl += `&start_date=${startDate}`;
                if (endDate) weatherUrl += `&end_date=${endDate}`;

                console.log('Loading data from:', weatherUrl);

                // Load weather data
                const weatherResponse = await fetch(weatherUrl);
                if (!weatherResponse.ok) {
                    throw new Error(`Erreur serveur (${weatherResponse.status})`);
                }
                const weatherData = await weatherResponse.json();

                console.log('Received data:', weatherData.data ? weatherData.data.length : 0, 'records');

                if (weatherData.error) {
                    showError(weatherData.error);
                    return;
                }

                // ‚úÖ Store data for export
                currentWeatherData = weatherData.data || [];
                
                // ‚úÖ Enable/disable export button
                document.getElementById('exportBtn').disabled = currentWeatherData.length === 0;

                // Display data based on FILTERED results
                displayStationInfo(stationData, weatherData.data, startDate, endDate);
                displayStatistics(weatherData.data);
                updateCharts(weatherData.data);
                updateDateInputStyles();

                // Show info message if filters are active
                if (startDate || endDate) {
                    const recordCount = weatherData.data ? weatherData.data.length : 0;
                    let filterMsg = `üîç Filtre actif: ${recordCount} relev√©(s) trouv√©(s)`;
                    if (startDate && endDate) {
                        filterMsg += ` du ${new Date(startDate).toLocaleDateString('fr-FR')} au ${new Date(endDate).toLocaleDateString('fr-FR')}`;
                    } else if (startDate) {
                        filterMsg += ` √† partir du ${new Date(startDate).toLocaleDateString('fr-FR')}`;
                    } else if (endDate) {
                        filterMsg += ` jusqu'au ${new Date(endDate).toLocaleDateString('fr-FR')}`;
                    }
                    showInfo(filterMsg);
                }

            } catch (error) {
                // ‚úÖ Better error messages
                let errorMsg = 'Erreur lors du chargement des donn√©es';
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Impossible de contacter le serveur. V√©rifiez que l\'API est d√©marr√©e : uvicorn src.api.main:app';
                } else if (error.message.includes('introuvable')) {
                    errorMsg = 'Station introuvable. Veuillez s√©lectionner une autre station.';
                } else {
                    errorMsg += ': ' + error.message;
                }
                showError(errorMsg);
                // ‚úÖ Disable export on error
                document.getElementById('exportBtn').disabled = true;
            } finally {
                showLoading(false);
            }
        }

        function displayStationInfo(station, filteredData, startDate, endDate) {
            const container = document.getElementById('stationInfo');
            // Clean station name
            const cleanName = station.station_name.replace(/^\d+-station-meteo-/i, '');
            
            // Calculate stats from FILTERED data
            let statsHtml = `
                <p><strong>üìç Station:</strong> ${cleanName}</p>
                <p><strong>üèôÔ∏è Localisation:</strong> ${station.location}</p>
            `;
            
            if (filteredData && filteredData.length > 0) {
                const temps = filteredData.map(d => d.temperature).filter(v => v != null);
                const avgTemp = temps.length > 0 ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) : '--';
                
                const timestamps = filteredData.map(d => new Date(d.timestamp));
                const minDate = new Date(Math.min(...timestamps));
                const maxDate = new Date(Math.max(...timestamps));
                
                statsHtml += `
                    <p><strong>üìä Relev√©s affich√©s:</strong> ${filteredData.length}</p>
                    <p><strong>üå°Ô∏è Temp√©rature moyenne:</strong> ${avgTemp}¬∞C</p>
                    <p><strong>üìÖ P√©riode affich√©e:</strong> ${minDate.toLocaleDateString('fr-FR')} - ${maxDate.toLocaleDateString('fr-FR')}</p>
                `;
                
                // Show filter info if dates are selected
                if (startDate || endDate) {
                    statsHtml += `<p><strong>üîç Filtre actif:</strong> `;
                    if (startDate && endDate) {
                        statsHtml += `du ${new Date(startDate).toLocaleDateString('fr-FR')} au ${new Date(endDate).toLocaleDateString('fr-FR')}`;
                    } else if (startDate) {
                        statsHtml += `√† partir du ${new Date(startDate).toLocaleDateString('fr-FR')}`;
                    } else if (endDate) {
                        statsHtml += `jusqu'au ${new Date(endDate).toLocaleDateString('fr-FR')}`;
                    }
                    statsHtml += `</p>`;
                }
            } else {
                statsHtml += `
                    <p><strong>‚ö†Ô∏è Aucune donn√©e disponible pour cette p√©riode</strong></p>
                    <p><em>Total disponible: ${station.total_records} relev√©s</em></p>
                `;
            }
            
            container.innerHTML = statsHtml;
        }

        function displayStatistics(data) {
            if (!data || data.length === 0) {
                // Show "no data" message
                document.getElementById('avgTemp').textContent = '--';
                document.getElementById('minMaxTemp').textContent = '--';
                document.getElementById('avgHumidity').textContent = '--';
                document.getElementById('totalRain').textContent = '0.0 mm';
                document.getElementById('avgWind').textContent = '--';
                document.getElementById('avgPressure').textContent = '--';
                document.getElementById('recordCount').textContent = '0';
                document.getElementById('datePeriod').textContent = 'Aucune donn√©e';
                return;
            }

            const temps = data.map(d => d.temperature).filter(v => v != null);
            const humidity = data.map(d => d.humidity).filter(v => v != null);
            const rain = data.map(d => d.rainfall).filter(v => v != null);
            const wind = data.map(d => d.wind_speed).filter(v => v != null);
            const pressure = data.map(d => d.pressure).filter(v => v != null);
            const timestamps = data.map(d => new Date(d.timestamp));

            // Temperature
            document.getElementById('avgTemp').textContent = 
                temps.length > 0 ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) + '¬∞C' : '--';
            
            document.getElementById('minMaxTemp').textContent = 
                temps.length > 0 ? `${Math.min(...temps).toFixed(1)}¬∞ / ${Math.max(...temps).toFixed(1)}¬∞` : '--';
            
            // Humidity
            document.getElementById('avgHumidity').textContent = 
                humidity.length > 0 ? (humidity.reduce((a, b) => a + b, 0) / humidity.length).toFixed(0) + '%' : '--';
            
            // Rainfall
            const totalRainfall = rain.reduce((a, b) => a + b, 0);
            document.getElementById('totalRain').textContent = 
                rain.length > 0 ? totalRainfall.toFixed(1) + ' mm' : '0.0 mm';
            
            // Wind
            document.getElementById('avgWind').textContent = 
                wind.length > 0 ? (wind.reduce((a, b) => a + b, 0) / wind.length).toFixed(1) + ' m/s' : '--';
            
            // Pressure (convert Pa to hPa)
            document.getElementById('avgPressure').textContent = 
                pressure.length > 0 ? (pressure.reduce((a, b) => a + b, 0) / pressure.length / 100).toFixed(0) + ' hPa' : '--';
            
            // Record count
            document.getElementById('recordCount').textContent = data.length;
            
            // Date period - show actual filtered data range
            if (timestamps.length > 0) {
                const minDate = new Date(Math.min(...timestamps));
                const maxDate = new Date(Math.max(...timestamps));
                const startDateStr = minDate.toLocaleDateString('fr-FR', {day: '2-digit', month: 'short'});
                const endDateStr = maxDate.toLocaleDateString('fr-FR', {day: '2-digit', month: 'short', year: 'numeric'});
                document.getElementById('datePeriod').textContent = `${startDateStr} - ${endDateStr}`;
            } else {
                document.getElementById('datePeriod').textContent = '--';
            }
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            updateDateInputStyles();
            loadWeatherData();
        }

        function updateDateInputStyles() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            if (startDate.value) {
                startDate.classList.add('active');
            } else {
                startDate.classList.remove('active');
            }
            
            if (endDate.value) {
                endDate.classList.add('active');
            } else {
                endDate.classList.remove('active');
            }
        }

        function updateCharts(data) {
            if (!data || data.length === 0) {
                // Clear all charts if no data
                if (tempChart) tempChart.destroy();
                if (humidityChart) humidityChart.destroy();
                if (rainChart) rainChart.destroy();
                if (windChart) windChart.destroy();
                if (pressureChart) pressureChart.destroy();
                return;
            }

            // Sort by timestamp
            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const labels = data.map(d => new Date(d.timestamp).toLocaleDateString('fr-FR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit'
            }));

            // Temperature Chart
            if (tempChart) tempChart.destroy();
            const tempCtx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temp√©rature (¬∞C)',
                        data: data.map(d => d.temperature),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Humidity Chart
            if (humidityChart) humidityChart.destroy();
            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Humidit√© (%)',
                        data: data.map(d => d.humidity),
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Rain Chart
            if (rainChart) rainChart.destroy();
            const rainCtx = document.getElementById('rainChart').getContext('2d');
            const rainfallData = data.map(d => {
                const val = d.rainfall;
                return (val != null && val !== undefined) ? val : 0;
            });
            rainChart = new Chart(rainCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pr√©cipitations (mm)',
                        data: rainfallData,
                        backgroundColor: '#4facfe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Wind Chart
            const windData = data.map(d => d.wind_speed).filter(v => v != null);
            if (windData.length > 0) {
                if (windChart) windChart.destroy();
                const windCtx = document.getElementById('windChart').getContext('2d');
                windChart = new Chart(windCtx, {
                    type: 'line',
                    data: {
                        labels: labels.slice(0, windData.length),
                        datasets: [{
                            label: 'Vitesse du vent (m/s)',
                            data: windData,
                            borderColor: '#fa709a',
                            backgroundColor: 'rgba(250, 112, 154, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Pressure Chart (convert Pa to hPa)
            const pressureData = data.map(d => d.pressure ? d.pressure / 100 : null).filter(v => v != null);
            if (pressureData.length > 0) {
                if (pressureChart) pressureChart.destroy();
                const pressureCtx = document.getElementById('pressureChart').getContext('2d');
                pressureChart = new Chart(pressureCtx, {
                    type: 'line',
                    data: {
                        labels: labels.slice(0, pressureData.length),
                        datasets: [{
                            label: 'Pression (hPa)',
                            data: pressureData,
                            borderColor: '#a8edea',
                            backgroundColor: 'rgba(168, 237, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }

        function showLoading(show) {
            document.getElementById('loadingContainer').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error"><strong>Erreur:</strong> ${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showInfo(message) {
            const container = document.getElementById('infoContainer');
            container.innerHTML = `<div class="info-message">${message}</div>`;
        }

        function clearInfo() {
            document.getElementById('infoContainer').innerHTML = '';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', loadStations);
    </script>
</body>
</html>
